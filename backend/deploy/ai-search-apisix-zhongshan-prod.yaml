apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: health-knowledge-assistant-route
  namespace: health-zhongshan-prod
spec:
  http:
  - backends:
    - serviceName: health-knowledge-assistant-service
      servicePort: 8088
    match:
      hosts:
      - 116.204.82.132
      paths:
      - "/forward/api/*"
    name: "forward"
    priority: 10
    plugins:
    - name: "proxy-rewrite"
      enable: true
      config:
        regex_uri:
        - "^/forward/api/(.*)"
        - "/api/$1"
        headers:
          set:
            Client-Type: "forward"
  - backends:
    - serviceName: health-knowledge-assistant-service
      servicePort: 8088
    match:
      hosts:
      - 116.204.82.132
      paths:
      - /knowledge-assistant/api/*
    name: backend
    plugins:
    - config:
        bearer_only: false
        client_id: health-knowledge-assistant-zhongshan-prod
        client_secret: LNYE588lYjPVen4fVdeGP1OdWl8IAx1P
        discovery: https://login.infly.cn/realms/inf-public/.well-known/openid-configuration
        introspection_endpoint_auth_method: client_secret_post
        realm: inf-public
        redirect_uri: http://116.204.82.132/knowledge-assistant/api/balabala
        scope: openid profile
        session:
          secret: EE1z9v0VFlJUmzejPNye8sRQ2mzFaRyhMegxEApUfTM=
      enable: true
      name: openid-connect
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri:
        - "^/knowledge-assistant/api/(.*)"
        - "/api/$1"
    - name: response-rewrite
      config:
        status_code: 401
        vars:
        - - status
          - ==
          - 302
        - - uri
          - '!'
          - ~~
          - balabala
      enable: true
  - backends:
    - serviceName: health-assistant-fe
      servicePort: 8000
    match:
      hosts:
      - 116.204.82.132
      paths:
      - /knowledge-assistant
      - /knowledge-assistant/*
      - /logout
    name: frontend
    plugins:
    - config:
        bearer_only: false
        client_id: health-knowledge-assistant-zhongshan-prod
        client_secret: LNYE588lYjPVen4fVdeGP1OdWl8IAx1P
        discovery: https://login.infly.cn/realms/inf-public/.well-known/openid-configuration
        introspection_endpoint_auth_method: client_secret_post
        realm: inf-public
        redirect_uri: http://116.204.82.132/knowledge-assistant/api/balabala
        scope: openid profile
        session:
          secret: EE1z9v0VFlJUmzejPNye8sRQ2mzFaRyhMegxEApUfTM=
      enable: true
      name: openid-connect
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri:
        - "^/knowledge-assistant/(.*)"
        - "/$1"
    - name: response-rewrite
      config:
        headers:
          set:
            location: /
        status_code: 302
        vars:
        - - status
          - ==
          - 500
        - - uri
          - ~~
          - balabala
      enable: true